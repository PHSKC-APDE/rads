---
title: "Analyzing HYS data in rads"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyzing HYS data in rads}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The Healthy Youth Survey (HYS) is adminstered to WA state public school 6th, 8th, and 12th (and somethings 9th and 11th) grade students. It asks questions about sex, drugs, mental health, demographics and a series of other fun things. This vignette is designed to provid and overview of how to analyze HYS data using the `rads` package.

To begin, we load the rads package. Because it is dangerous to go at it alone, the rads package relies on a number of other packages to work its barely functional magic. For survey analysis, rads relies on the `srvyr`, `data.table`, and `dplyr` packages for survey statistics, data munging, and horrific quasiquotation programming respectively.  

```{r setup}
library(rads)
library('srvyr') #analyzing surveys
library('dplyr') #data manipulation and stress
```

Generally speaking, having a dataset is a necessary component of doing data analysis. `rads` regularly adds new datasets, and so provides a helper function to help users figure out which datasets are available. Note, the `rads::` is just there to highlight that we are executing a function from the `rads` package.

```{r listdatasets}
rads::list_apde_data()
```

Hark! The HYS dataset is available to load and analyze! What happy times! However, before we load the dataset, it might be worth checking what variables it contains. This can be useful if you only want to load a subset of the dataset for SPEED and MEMORY SAVING. You can do this like so:

```{r listvariables}
rads::list_dataset_columns(dataset = 'hys', analytic_only = F)
```

So the results are a bit disappointing, but this function will work better when the HYS dataset migrates to SQL. Anyways, we can imagine examining the list of columns to select which ones are best and are the most flattering. For now, we'll just load the whole analytical dataset for 2016 and 2018.

```{r loaddata}
hys <- get_data('hys', year = c(2016, 2018))
```

It behooves us to examine what exactly we have loaded. A good place to start is by checking the `class`. We also check the dimensions (`dim(hys)`) for giggles.

```{r checkclass}
print(paste0('The classes are: ', paste(class(hys), collapse = ', ')))

d = dim(hys)
print(paste('The dataset has', d[1], 'respondents and', d[2], 'columns loaded'))

```

 Some things to note from the results of the last codeblock.
 1. The `hys` object is 4 classes-- `tbl_svy` from the `srvyr` package, `survey.design2` and `survey.design1` from the underlying `survey` package, and `apde_hys` which the `rads` package appends to make some of the helper functions work. Classes are important because they help R figure out which functions and operations are proper to execute on a given object.
 2. A `tbl_svy` is basically like a `tibble` from the `dplyr` package that is svyset (to borrow from stata vernacular). This means things like `filter`, `mutate`, `greoup_by` and other `dplyr` verbs will work on `tbl_svy` objects. The verb that is likely to be of the most interest is the `summarize` one. To properly compute survey weighted metrics, one must use functions in the form of `survey_mean` and what not. The `?summarize` page has a full listing.
 3. While `dplyr` verbs will (sort of) work on the `hys` object, other mechanisms of data manipulation (e.g. base R or `data.table`) will not work without some modification. The way `tbl_svy` objects are structured means the underlying `data.frame`/`tibble` is stored in `hys$variables`. While you can alter this item outside the `dplyr` verb environment, it is not recommended because screwing with the variables that inform the survey design (e.g. psu, strata, and pweight) can make things go haywire. At some point the `rads` package might include the functionality to return just the raw data.frame so folks can svyset it themselves-- but at the moment, I'm lazy.
 
Presumably, if you, dear reader, have made it this far, you are anxious to start computing some health metrics. Hip. Hip. Hooray. Assuming you don't need to do anything super fancy (e.g. you want a King County only number), you can do something like:

```{r babysfirstcomputation}

res <- hys %>% tabulate_variable(variable = 'ecig_vape',
                                 metrics = rads::survey_metrics(),
                                 sex = 'both',
                                 grade = NULL, #all grades
                                 region = NULL, #all regions
                                 race = 'all', #a_race8,
                                 year = c(2016, 2018), #each year seperately
                                 sexual_orientation = NULL,
                                 na.rm = T
                                 )

```


