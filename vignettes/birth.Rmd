---
title: "Exploring Birth Data with RADS"
output:
  html_document: default
  rmarkdown::html_vignette: default
vignette: >
  %\VignetteIndexEntry{Exploring Birth Data with RADS}
---

## Introduction
This vignette will provide some examples of ways to explore and analyze birth data using `rads`, APDE's 'R Automated Data System'. `rads` is a suite custom tools and utilities that can be used to analyze survey and record level data for [CHI](https://www.kingcounty.gov/chi), [data requests](https://kingcounty.gov/depts/health/data/data-request-service.aspx), and other APDE projects. Spending the time getting familiar with `rads` now should save you many hours of coding if you will need to calculate standard metrics such as means and rates in the future.   

**NOTE!!** To get the most out of this vignette, I highly recommend that you actually type each and every bit of code into R. Doing so will almost definitely help you learn the syntax much faster than just reading the vignette or copying and pasting the code.

## Installation
You will need to install [R](https://cran.r-project.org/bin/windows/base/), [Rstudio](https://rstudio.com/products/rstudio/download/#download), and the [`devtools`](https://cran.r-project.org/web/packages/devtools/index.html) and [`rads`](https://github.com/PHSKC-APDE/rads) packages. If needed, 

1) Install R and Rstudio the way you would install any other software. 
2) Install the `devtools` package in R by typing `install.packages("devtools")` in the R console. After successfully installing `devtools`...
3) Install `rads` by typing `devtools::install_github("PHSKC-APDE/rads")` in the R console. 
    * If you received a 404 error rather than a successful installation, it is probably because you need to provide authentication to connect to our private GitHub repository. If you have not created and saved a GitHub PAT (Personal Access Token), please follow the detailed instructions in the [`APDE Training/R` wiki](https://teams.microsoft.com/l/channel/19%3A0735c1c38f4e49aa88c9b18b54105914%40thread.skype/tab%3A%3A9153588c-6c86-433d-8b98-0578f27d4cd1?groupId=a338cf08-e066-48cd-9f4c-cb91fcca199f&tenantId=bae5059a-76f0-49d7-9996-72dfe95d69c7)
    * After following the instructions above, please try typing the following: `devtools::install_github("PHSKC-APDE/rads", auth_token = Sys.getenv("GITHUB_PAT"))`
4) Exit R studio and starting it again. You should now be ready to walk through this vignette. 

## Getting data
Begin by loading the `rads` package/library by typing the following in R:
```{r}
library(rads)
```

The analytic ready birth data is stored in on KCIT SQL Server 50 (`[PH_APDEStore].[final].[bir_wa]`). The `get_data_birth()` function will allow you to pull data from the SQL server with minimal fuss. To see the possible arguments that you can pass, use the `args()` function by typing the following:
```{r}
args(get_data_birth)
```
You can see that `get_data_birth` takes three possible arguments:

1) `cols` <- a vector of the specific columns that you want to load into memory, e.g., `c("chi_year", "chi_geo_regions_4")`. If it is not specified, the default is `NA`, which will pull all available columns. 
    * In the future, standardized documentation, including a data dictionary, will be available to help you identify the birth columns of interest. However, for the time being, I suggest viewing our [birth recodes csv](https://github.com/PHSKC-APDE/DOHdata/blob/master/ETL/birth/ref/ref.bir_recodes_simple.csv) to identify APDE generated variables and the [field name map csv](https://github.com/PHSKC-APDE/DOHdata/blob/master/ETL/birth/ref/ref.bir_field_name_map.csv) to identify the APDE column name ascribed to any given WHALES or Bedrock column name.  
2) `year` <- a vector of the year or years of data that you want to load, e.g., c(2011, 2015:2018). Note that the default is to load 2017 data only. 
3) `kingco` <- a logical argument (i.e., `T` or `F` only, without quotes) denoting whether or not the data should be limited to King County. The default is King County only. 

Let's try the function to see how it works by loading the year and King County columns for WA State in 2018:
```{r}
birth <- get_data_birth(year = c(2018), cols = c("chi_year", "chi_geo_kc"), kingco = F)
```
We can confirm the `birth` object is in our environment by typing `ls()`
```{r}
ls() 
```
To identify the class of the `birth` object, we can type `class(birth)`
```{r}
class(birth) 
```
The `dim()` function tells us the dimensions of the `birth` table. In this case, it has `r nrow(birth)` rows and `r ncol(birth)` columns
```{r}
dim(birth) 
```
Use the `head()` command to take a peak at the first 6 lines of the `birth` table
```{r}
head(birth) 
```

## Introducing the `calc` function
`calc` is the analytic workhorse of `rads`. It provides a standardized method for obtaining most of what we usually want to calculate: means, medians, counts, confidence intervals, standard errors, relative standard errors (RSE), numerators, denominators, the number missing, and the proportion missing. In this case, using the `args()` function will not be very helpful:
```{r}
args(calc)
```
This is because calc is a front end for two engines: [`calc.data.frame`](https://github.com/PHSKC-APDE/rads/blob/master/R/calc.data.frame.R) for record level data & [`calc.tbl_svy`](https://github.com/PHSKC-APDE/rads/blob/master/R/calc.tbl_svy.R) for survey data. The good news is that you can ignore this and use the following standard set of arguments:

1) `ph.data` <- the name of the data.table or survey object that you want to analyze. In our case, `birth`.
2) `what` <- a character vector of the variables for which you want to calculate the metrics. E.g., `what = c("preterm")`
3) `...` <- think of this as a "where" statement, i.e., a filter or subsetting of data. E.g., `chi_geo_zip5 %in% c(98001:98010)`. **NOTE** do not type `...` !
4) `by` <- a character vector of the variables that you want to computer the `what` by, i.e., the cross-tab variable(s). E.g., `by = c("mother_birthplace_foreign")`
5) `metrics` <- a character vector of the metrics that you want returned. E.g., `metrics = c("mean", "rse")`. You can see a complete list of available metrics by typing `record_metrics()`
6) `per` <- an integer, which is the denominator when `rate` is selected as the metric. Metrics will be multiplied by this value. E.g., `per = 1000`
7) `win` <- an integer, which is the number of consecutive units of time (e.g., years, months, etc.) over which the metrics will be calculated, i.e., the 'window' for a rolling average, sum, etc. E.g. `win = 5` will perform calculations over every 5 time unit window.
8) `time_var` <- a character, which is the name of the time variable in the dataset. Used in combination with the `win` argument to generate time windowed calculations.
9) `proportion` <- a logical (i.e., `T` or `F`) flag determining whether the metrics should be calculated as a proportion. Currently only relevant for survey data. 
10) `verbose` <- a logical used to toggle on/off printed warnings

There is no need to specify all of the arguments listed above. As the following example shows, the `calc` function simply needs a specified dataset (i.e., `pha.data`) and at least one `what` variable to return an intelliglbe result. In this case it will provide the proportion of all WA State births that took place in King County in 2018.
```{r}
result.1 <- calc(birth, what = c("chi_geo_kc") )
head(result.1)
```


## Introducing helper functions
The many helper functions and utilities that have been created for RADS will be documented in detail in the future. We limit ourselves to the few immediately relevant to post-processing of data analyzed with the `calc` function. 

* `digits` <- This function rounds data following APDE/CHI generic standards or custom requests. By default, this function expects data that has already been formatted for CHI, i.e., it contains `result`, `lower_bound`, `upper_bound`, `se`, `rse` columns. However, the variables and the number of digits to round can be readily specified. Typing `args(digits)` reveals that there are 5 possible arguments:
    * `digit_data` <- a data.table or data.frame containing the data to be rounded
    * `vars_1` <- a character vector of indeterminate length. It specifies the variables to be rounded to the number of digits specified by `digits_1`. If not specified it defaults to `c("result", "lower_bound", "upper_bound", "rse")`, which are the relevant columns in CHI Tableau Ready data.
    * `digits_1` <- an integer representing the number of decimal places to round variables specified in vars_1. The default is digits_1 = 3, i.e., 0.123456 >> 0.123.
    * `vars_2` <- a character vector of indeterminate length. It specifies the variables to be rounded to the number of digits specified by `digits_2`. If not specified it defaults to `c("se")`
    * `digits_2` <- an integer representing the number of decimal places to round variables specified in vars_1. The default is digits_1 = 4, i.e., 0.123456 >> 0.1235.
* `round2` <- R's built-in `round` function doesn't act the way most of us might expect. `round2` rounds the way you were taught in elementary school, i.e., >=5 rounds up. E.g., `round2(0.135, 2)` == `r round2(0.135, 2)` whereas `round2(0.134, 2)` == `r round2(0.134, 2)`. 
* `suppress` <- This function suppresses data output by the `calc` function according to APDE standards or custom requests and adds a caution flag for large RSEs. When the reference sheet of all suppression guidelines is complete, this code will reference that sheet to apply the relevant suppression algorithm. In the meantime, the default suppression algorithm is as described by the [DOH](https://www.doh.wa.gov/Portals/1/Documents/1500/SmallNumbers.pdf). At present, this functon takes two arguments:
    * `sup_data` <- a data.table or data.frame containing the data to be suppressed with the standard CHI Tableau metric names (e.g., mean, median, numerator, etc.).
    * `suppress_range` <- an integer vector of length 2, which specifies the minimum and maximum range for suppression.
* `joinpoint` <- this function runs NCI's [JoinPoint](https://surveillance.cancer.gov/joinpoint/) from within R. Its inputs, outputs, and arguments are somewhat complex and will be described in full in a future stand-alone vignette. 

We will not use any of the above post-processing helper functions in this vignette. For now, just know that they exist and wait expectantly for future vignettes that demostrate their utility. 

***

## Example analyses
### Preterm births in KC 2013-2018
**get data**
```{r}
birth <- get_data_birth(year = c(2013:2018), cols = c("chi_year", "preterm"), kingco = T)
```

**calc all years**
```{r}
birth_all <- calc(birth, what = c("preterm"), metrics = c("mean", "rse", "total") )
head(birth_all)
```

**calc single years**
```{r}
birth_single <- calc(birth, what = c("preterm"), metrics = c("mean", "rse", "total"), 
                  by = c("chi_year"))
head(birth_single)
```

**calc 3 year window**
```{r}
birth_window <- calc(birth, what = c("preterm"), metrics = c("mean", "rse", "total"), 
                  win = 3)
head(birth_window)
```

**calc 3 year window (RATE per 1000)**
```{r}
birth_window <- calc(birth, what = c("preterm"), metrics = c("rate", "rse", "total"), 
                  win = 3, per = 1000)
head(birth_window)
```


### Intersection of Low Birth Weight & Prematurity in KC (last 5 years combined)
**get data**
```{r}
birth <- get_data_birth(year = c(2014:2018), cols = c("chi_year", "preterm", "bw_low"), kingco = T)
```
**recode data **
```{r}
birth[, preterm_lbw := 0][preterm == 1 & bw_low == 1, preterm_lbw := 1]
```
**calc 5 year**
```{r}
birth_5y <- calc(birth, what = c("preterm_lbw"), 
                 metrics = c("mean", "rse", "numerator", "denominator", "missing") )
head(birth_5y)
```

**calc 5 year rate per 100,000**
```{r}
birth_5yrate <- calc(birth, what = c("preterm_lbw"), per = 100000, 
              metrics = c("rate", "rse", "numerator", "denominator", "missing") )
head(birth_5yrate)
```

### Premature by race and foreign born status in KC (singe year and multiple years) 
**get data**
```{r}
birth <- get_data_birth(year = c(2014:2018), 
                        cols = c("chi_year", "preterm", "chi_race_eth8", "mother_birthplace_foreign"), 
                        kingco = T)

```
**calc 5 year**
```{r}
birth_5y <- calc(birth, what = "preterm", by = c("chi_race_eth8", "mother_birthplace_foreign"), 
                 metrics = c("mean", "rse", "numerator"))
head(birth_5y)
```


**calc 1 year**
```{r}
birth_1y <- calc(birth, what = "preterm", 
                 by = c("chi_race_eth8", "mother_birthplace_foreign", "chi_year"), 
                 metrics = c("mean", "rse", "numerator"))
head(birth_1y)
```
Note that this only shows the earliest years. By using the `tail()` function, we can view the end of the more recent years
```{r}
tail(birth_1y)
```

### Premature by race in specific geographies
**get data** 
```{r}
birth <- get_data_birth(year = c(2014:2018), 
                        cols = c("chi_year", "preterm", "chi_race_eth8", "chi_geo_big_cities", "chi_geo_hra_short", "chi_geo_zip5"))
```

**calc by each "big city"**
```{r}
birth_big <-  calc(birth, what = "preterm", by = c("chi_race_eth8", "chi_geo_big_cities"), 
                   metrics = c("mean", "rse"))
head(birth_big)
```

**calc within a limited set of zip codes**
```{r}
birth_zip <- calc(birth, what = "preterm", chi_geo_zip5 %in% c(98001:98010), by = c("chi_race_eth8"), 
                  metrics = c("mean", "rse"))
head(birth_zip)
```
**calc by HRAs like "Auburn"**
```{r}
birth_hra <-  calc(birth, 
                   what = "preterm", 
                   chi_geo_hra_short %like% c("Auburn"), 
                   by = c("chi_race_eth8", "chi_geo_hra_short"), 
                   metrics = c("mean", "rse"))
head(birth_hra)      
```


### Custom sub-populations
**get data**
```{r}
birth <- get_data_birth(year = c(2014:2018), 
                        cols = c("chi_year", "chi_age", "chi_geo_hra_long", "chi_race_eth8", "dlp_medicaid", "prior_live_births_living", "prior_live_births_deceased"))
```
**calc Medicaid births, first time moms, under 23, by HRA and by race**
```{r}
birth_custom1 <- calc(birth, what = "dlp_medicaid", 
                      (prior_live_births_living + prior_live_births_deceased == 0) & chi_age < 23, 
                      by = c("chi_geo_hra_long", "chi_race_eth8"))
head(birth_custom1)
```

### Custom geographies      
**get data**
```{r}
birth <- get_data_birth(year = c(2014:2018), cols = c("chi_year", "chi_geo_hra_long"))
```

**recode data**
```{r}
birth[, Duamish := 0]
birth[chi_geo_hra_long %in% c("Beacon Hill/Georgetown/South Park", "Delridge"), Duamish := 1]
```
**calc % of all births that were in Duamish, by year**
```{r}
birth_custom_2 <- calc(birth, what = "Duamish", metrics = c("mean", "rse"), by = c("chi_year"))
head(birth_custom_2)
```

**calc # of births in Duamish, by year**  
```{r}
birth_custom_3 <- calc(birth, Duamish == 1, what = "Duamish", metrics = c("total"), by = c("chi_year"))
head(birth_custom_3)
```








