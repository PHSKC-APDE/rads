<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>calc()</title>
<style type="text/css">
/**
 * Prism.s theme ported from highlight.js's xcode style
 */
pre code {
  padding: 1em;
}
.token.comment {
  color: #007400;
}
.token.punctuation {
  color: #999;
}
.token.tag,
.token.selector {
  color: #aa0d91;
}
.token.boolean,
.token.number,
.token.constant,
.token.symbol {
  color: #1c00cf;
}
.token.property,
.token.attr-name,
.token.string,
.token.char,
.token.builtin {
  color: #c41a16;
}
.token.inserted {
  background-color: #ccffd8;
}
.token.deleted {
  background-color: #ffebe9;
}
.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
}
.token.atrule,
.token.attr-value,
.token.keyword {
  color: #836c28;
}
.token.function,
.token.class-name {
  color: #DD4A68;
}
.token.regex,
.token.important,
.token.variable {
  color: #5c2699;
}
.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}
</style>
<style type="text/css">
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  box-sizing: border-box;
}
body, .footnotes, code { font-size: .9em; }
li li { font-size: .95em; }
*, *:before, *:after {
  box-sizing: inherit;
}
pre, img { max-width: 100%; }
pre, pre:hover {
  white-space: pre-wrap;
  word-break: break-all;
}
pre code {
  display: block;
  overflow-x: auto;
}
code { font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace; }
:not(pre) > code, code[class] { background-color: #F8F8F8; }
code.language-undefined, pre > code:not([class]) {
  background-color: inherit;
  border: 1px solid #eee;
}
table {
  margin: auto;
  border-top: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color: #666;
  margin: 0;
  padding-left: 1em;
  border-left: 0.5em solid #eee;
}
hr, .footnotes::before { border: 1px dashed #ddd; }
.frontmatter { text-align: center; }
#TOC .numbered li { list-style: none; }
#TOC .numbered { padding-left: 0; }
#TOC .numbered ul { padding-left: 1em; }
table, .body h2 { border-bottom: 1px solid #666; }
.body .appendix, .appendix ~ h2 { border-bottom-style: dashed; }
.footnote-ref a::before { content: "["; }
.footnote-ref a::after { content: "]"; }
section.footnotes::before {
  content: "";
  display: block;
  max-width: 20em;
}

@media print {
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  tr, img { page-break-inside: avoid; }
}
@media only screen and (min-width: 992px) {
  pre { white-space: pre; }
}
</style>
</head>
<body>
<div class="frontmatter">
<div class="title"><h1>calc()</h1></div>
<div class="author"><h2></h2></div>
<div class="date"><h3></h3></div>
</div>
<div class="body">
<h2 id="introduction">Introduction</h2>
<p><code>calc()</code> is the analytic workhorse of <code>rads</code>. It provides a standardized method for obtaining most of what we usually want to calculate: means, medians, counts, confidence intervals, standard errors, relative standard errors (RSE), numerators, denominators, the number missing, and the proportion missing. <code>calc()</code> can be used with record data (e.g., vital statistics, census, enrollment numbers, etc.) as well as survey data (e.g., <a href="https://www.cdc.gov/brfss/index.html">BRFSS</a>, <a href="https://github.com/PHSKC-APDE/svy_acs">ACS PUMS</a>, etc.). <code>calc()</code> is built on top of common R packages and was created to allow APDE staff the convenience of using a common syntax across various data sources. This means that everything <code>calc</code> can do can be done with other packages … sometimes in a more efficient manner.</p>
<p>This vignette will provide some examples to introduce the <code>calc()</code> function by walking through basic analyses with vital statistics (birth data) and survey data (ACS PUMS). To get the most out of this vignette, we recommend that you type each and every bit of code into R. Doing so will almost definitely help you learn the syntax much faster than just reading the vignette or copying and pasting the code.</p>
<h2 id="calc-arguments"><code>calc()</code> arguments</h2>
<p>Arguments are the values that we send to a function when it is called. The standard arguments for <code>calc()</code> are:</p>
<ol>
<li>
<p><code>ph.data</code> &lt;- the name of the data.table/data.frame or survey object that you want to analyze.</p>
</li>
<li>
<p><code>what</code> &lt;- a character vector of the variable(s) for which you want to calculate the metrics. E.g., <code>what = c(&quot;uninsured&quot;)</code></p>
</li>
<li>
<p><code>where</code> &lt;- think of this as a SQL <code>WHERE</code> clause, i.e., a filtering or subsetting of data. E.g., <code>ages %in% c(0:17) &amp; gender == &quot;Female&quot;</code></p>
</li>
<li>
<p><code>by</code> &lt;- a character vector of the variables that you want to computer the <code>what</code> by, i.e., the cross-tab variable(s). E.g., <code>by = c(&quot;gender&quot;)</code> would stratify results by gender</p>
</li>
<li>
<p><code>metrics</code> &lt;- a character vector of the metrics that you want returned. E.g., <code>metrics = c(&quot;mean&quot;, &quot;rse&quot;)</code>. You can see a complete list of available metrics by typing <code>metrics()</code> and get detailed descriptions of what each metric means by typing <code>?metrics()</code>.</p>
</li>
<li>
<p><code>per</code> &lt;- an integer, which is the denominator when <code>rate</code> is selected as a metric. Metrics will be multiplied by this value. E.g., <code>per = 1000</code>. <strong>NOTE</strong> this is just a scalar. At present this does not calculate a true rate (i.e., the relevant population denominator is not used).</p>
</li>
<li>
<p><code>win</code> &lt;- an integer, which is the number of consecutive units of time (e.g., years, months, etc.) over which the metrics will be calculated, i.e., the ‘window’ for a rolling average, sum, etc. E.g. <code>win = 5</code> will perform calculations over every 5 time unit window.</p>
</li>
<li>
<p><code>time_var</code> &lt;- a character, which is the name of the time variable in the dataset. Used in combination with the <code>win</code> argument to generate time windowed calculations.</p>
</li>
<li>
<p><code>fancy_time</code> &lt;- a logical (i.e., <code>T</code> or <code>F</code>) flag. If TRUE, a record of all the years going into the data is returned. If FALSE, just a simple range (where certain years within the range might not be represented in your data).</p>
</li>
<li>
<p><code>proportion</code> &lt;- a logical (i.e., <code>T</code> or <code>F</code>) flag determining whether the metrics should be calculated as a proportion. Currently only relevant for survey data. The default is FALSE.</p>
</li>
<li>
<p><code>ci</code> &lt;- a numeric value between 0 &amp; 1 for the confidence level returned in the estimates. E.g., 0.95 == 95% confidence interval</p>
</li>
<li>
<p><code>verbose</code> &lt;- a logical used to toggle on/off printed warnings</p>
</li>
</ol>
<p>There is no need to specify all of the arguments listed above. As you can see in the following example, the <code>calc</code> function simply needs a specified dataset (i.e., <code>ph.data</code>) and at least one <code>what</code> variable to return an intelligible result.</p>
<pre><code class="language-r">data(mtcars)
calc(ph.data = mtcars, what = c(&quot;mpg&quot;))[]
</code></pre>
<pre><code>##    variable     mean numerator denominator  level  mean_se mean_lower
##      &lt;char&gt;    &lt;num&gt;     &lt;num&gt;       &lt;int&gt; &lt;lgcl&gt;    &lt;num&gt;      &lt;num&gt;
## 1:      mpg 20.09062     642.9          32     NA 1.065424   18.00243
##    mean_upper
##         &lt;num&gt;
## 1:   22.17882
</code></pre>
<p><strong>Note:</strong> <em>The use of <code>[]</code> after <code>calc()</code> is used to print the output to the console. Typically, you would not print the results but would save them as an object. E.g., <code>my.est &lt;- calc()</code>.</em></p>
<hr />
<h2 id="example-vital-statistics-analyses">Example vital statistics analyses</h2>
<p><strong>First get the birth data (cf. <a href="https://github.com/PHSKC-APDE/rads/wiki/get_data">get_data vignette</a>)</strong></p>
<pre><code class="language-r">birth &lt;- get_data_birth(cols = c(&quot;chi_year&quot;, &quot;chi_sex&quot;, &quot;chi_race_eth8&quot;, 
                                 &quot;preterm&quot;, &quot;birth_weight_grams&quot;, &quot;mother_birthplace_state&quot;), 
                        year = c(2013:2019), 
                        kingco = T)
</code></pre>
<p><strong>mean (proportion) for a binary over multiple years</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;preterm&quot;), 
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     time_var = &quot;chi_year&quot;)[]
</code></pre>
<pre><code>##     chi_year variable       mean numerator denominator  level      mean_se
##       &lt;char&gt;   &lt;char&gt;      &lt;num&gt;     &lt;int&gt;       &lt;int&gt; &lt;lgcl&gt;        &lt;num&gt;
## 1: 2013-2019  preterm 0.09052329     15806      174607     NA 0.0006866673
##    mean_lower mean_upper       rse
##         &lt;num&gt;      &lt;num&gt;     &lt;num&gt;
## 1: 0.08917745 0.09186913 0.7585532
</code></pre>
<p><strong>mean (proportion) for a binary over multiple years – <code>where</code> newborn is male</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;preterm&quot;), 
     where = chi_sex == &quot;Male&quot;,
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     time_var = &quot;chi_year&quot;)[]
</code></pre>
<pre><code>##     chi_year variable       mean numerator denominator  level      mean_se
##       &lt;char&gt;   &lt;char&gt;      &lt;num&gt;     &lt;int&gt;       &lt;int&gt; &lt;lgcl&gt;        &lt;num&gt;
## 1: 2013-2019  preterm 0.09716898      8694       89473     NA 0.0009902013
##    mean_lower mean_upper      rse
##         &lt;num&gt;      &lt;num&gt;    &lt;num&gt;
## 1: 0.09522822 0.09910974 1.019051
</code></pre>
<p><strong>mean (proportion) for a binary over multiple years – <code>where</code> newborn is male born to a Hispanic mother</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;preterm&quot;), 
     where = chi_sex == &quot;Male&quot; &amp; chi_race_eth8 == &quot;Hispanic&quot;,
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     time_var = &quot;chi_year&quot;)[]
</code></pre>
<pre><code>##     chi_year variable      mean numerator denominator  level     mean_se
##       &lt;char&gt;   &lt;char&gt;     &lt;num&gt;     &lt;int&gt;       &lt;int&gt; &lt;lgcl&gt;       &lt;num&gt;
## 1: 2013-2019  preterm 0.1105628      1277       11550     NA 0.002918031
##    mean_lower mean_upper      rse
##         &lt;num&gt;      &lt;num&gt;    &lt;num&gt;
## 1:  0.1048435   0.116282 2.639253
</code></pre>
<p><strong>mean (proportion) for a binary over individual years</strong></p>
<pre><code class="language-r">birth[, cy := chi_year]
calc(ph.data = birth, 
     what = c(&quot;preterm&quot;), 
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     time_var = &quot;chi_year&quot;, 
     by = &quot;cy&quot;)[]
</code></pre>
<pre><code>##       cy chi_year variable       mean numerator denominator  level     mean_se
##    &lt;int&gt;   &lt;char&gt;   &lt;char&gt;      &lt;num&gt;     &lt;int&gt;       &lt;int&gt; &lt;lgcl&gt;       &lt;num&gt;
## 1:  2013     2013  preterm 0.09259783      2293       24763     NA 0.001842076
## 2:  2014     2014  preterm 0.08847557      2231       25216     NA 0.001788407
## 3:  2015     2015  preterm 0.08829787      2241       25380     NA 0.001781002
## 4:  2016     2016  preterm 0.08956837      2320       25902     NA 0.001774364
## 5:  2017     2017  preterm 0.09120521      2296       25174     NA 0.001814576
## 6:  2018     2018  preterm 0.08944869      2166       24215     NA 0.001834028
## 7:  2019     2019  preterm 0.09429394      2259       23957     NA 0.001888115
##    mean_lower mean_upper      rse
##         &lt;num&gt;      &lt;num&gt;    &lt;num&gt;
## 1: 0.08898743 0.09620823 1.989329
## 2: 0.08497036 0.09198078 2.021357
## 3: 0.08480717 0.09178857 2.017038
## 4: 0.08609068 0.09304606 1.981016
## 5: 0.08764871 0.09476172 1.989553
## 6: 0.08585406 0.09304332 2.050369
## 7: 0.09059331 0.09799458 2.002371
</code></pre>
<p><strong>mean (proportion) for a binary over windowed years</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;preterm&quot;), 
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     time_var = &quot;chi_year&quot;, 
     win = 3)[]
</code></pre>
<pre><code>##     chi_year variable       mean numerator denominator  level     mean_se
##       &lt;char&gt;   &lt;char&gt;      &lt;num&gt;     &lt;int&gt;       &lt;int&gt; &lt;lgcl&gt;       &lt;num&gt;
## 1: 2013-2015  preterm 0.08977030      6765       75359     NA 0.001041303
## 2: 2014-2016  preterm 0.08878663      6792       76498     NA 0.001028399
## 3: 2015-2017  preterm 0.08968557      6857       76456     NA 0.001033366
## 4: 2016-2018  preterm 0.09007717      6782       75291     NA 0.001043376
## 5: 2017-2019  preterm 0.09163417      6721       73346     NA 0.001065305
##    mean_lower mean_upper      rse
##         &lt;num&gt;      &lt;num&gt;    &lt;num&gt;
## 1: 0.08772938 0.09181122 1.159964
## 2: 0.08677101 0.09080226 1.158281
## 3: 0.08766021 0.09171093 1.152210
## 4: 0.08803219 0.09212215 1.158314
## 5: 0.08954621 0.09372213 1.162563
</code></pre>
<p><strong>mean for a continuous over windowed years</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;birth_weight_grams&quot;), 
     metrics = c(&quot;mean&quot;, &quot;rse&quot;), 
     time_var = &quot;chi_year&quot;, 
     win = 3)[]
</code></pre>
<pre><code>##     chi_year           variable     mean  level  mean_se mean_lower mean_upper
##       &lt;char&gt;             &lt;char&gt;    &lt;num&gt; &lt;lgcl&gt;    &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
## 1: 2013-2015 birth_weight_grams 3339.469     NA 2.122024   3335.310   3343.628
## 2: 2014-2016 birth_weight_grams 3336.555     NA 2.087116   3332.465   3340.646
## 3: 2015-2017 birth_weight_grams 3333.507     NA 2.068735   3329.452   3337.562
## 4: 2016-2018 birth_weight_grams 3327.129     NA 2.073889   3323.065   3331.194
## 5: 2017-2019 birth_weight_grams 3320.961     NA 2.088449   3316.868   3325.055
##           rse
##         &lt;num&gt;
## 1: 0.06354375
## 2: 0.06255302
## 3: 0.06205880
## 4: 0.06233269
## 5: 0.06288689
</code></pre>
<p><strong>mean for a continuous in 2019, by gender and race/eth</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;birth_weight_grams&quot;), 
     chi_year == 2019,
     metrics = c(&quot;mean&quot;, &quot;rse&quot;), 
     by = c(&quot;chi_race_eth8&quot;, &quot;chi_sex&quot;))[]
</code></pre>
<pre><code>##     chi_race_eth8 chi_sex           variable     mean  level     mean_se
##            &lt;fctr&gt;  &lt;fctr&gt;             &lt;char&gt;    &lt;num&gt; &lt;lgcl&gt;       &lt;num&gt;
##  1:         White    Male birth_weight_grams 3460.298     NA    7.489711
##  2:         Asian    Male birth_weight_grams 3231.952     NA    9.784437
##  3:       Oth/unk  Female birth_weight_grams 3223.599     NA   30.670381
##  4:       Oth/unk    Male birth_weight_grams 3315.557     NA   33.357232
##  5:      Multiple  Female birth_weight_grams 3251.312     NA   24.365976
##  6:      Hispanic    Male birth_weight_grams 3301.784     NA   14.310447
##  7:         White  Female birth_weight_grams 3340.295     NA    7.280580
##  8:         Asian  Female birth_weight_grams 3145.902     NA    9.419157
##  9:      Hispanic  Female birth_weight_grams 3270.074     NA   13.703835
## 10:         Black  Female birth_weight_grams 3196.872     NA   18.683442
## 11:      Multiple    Male birth_weight_grams 3369.178     NA   23.359494
## 12:         Black    Male birth_weight_grams 3306.213     NA   19.794051
## 13:          NHPI  Female birth_weight_grams 3287.541     NA   49.322668
## 14:          NHPI    Male birth_weight_grams 3444.178     NA   43.324387
## 15:          AIAN  Female birth_weight_grams 3251.965     NA   79.070604
## 16:         White    &lt;NA&gt; birth_weight_grams 1873.500     NA 1321.500000
## 17:          AIAN    Male birth_weight_grams 3438.641     NA   84.306018
##     mean_lower mean_upper        rse
##          &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
##  1:   3445.618   3474.977  0.2164470
##  2:   3212.775   3251.129  0.3027408
##  3:   3163.487   3283.712  0.9514328
##  4:   3250.178   3380.936  1.0060823
##  5:   3203.556   3299.069  0.7494198
##  6:   3273.736   3329.832  0.4334156
##  7:   3326.026   3354.565  0.2179622
##  8:   3127.441   3164.363  0.2994104
##  9:   3243.215   3296.933  0.4190681
## 10:   3160.253   3233.491  0.5844288
## 11:   3323.394   3414.962  0.6933292
## 12:   3267.418   3345.009  0.5986925
## 13:   3190.871   3384.212  1.5002905
## 14:   3359.264   3529.092  1.2579021
## 15:   3096.989   3406.940  2.4314716
## 16: -14917.750  18664.750 70.5364291
## 17:   3273.404   3603.877  2.4517252
</code></pre>
<p><strong>Proportion of 2017-2019 births among each race/eth group</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;chi_race_eth8&quot;), 
     chi_year %in% 2017:2019,
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;obs&quot;, &quot;numerator&quot;, &quot;denominator&quot;))[]
</code></pre>
<pre><code>##       level      variable denominator   obs       mean      mean_se  mean_lower
##      &lt;char&gt;        &lt;char&gt;       &lt;int&gt; &lt;int&gt;      &lt;num&gt;        &lt;num&gt;       &lt;num&gt;
## 1:     AIAN chi_race_eth8       73701 73701 0.00530522 0.0002675857 0.004805929
## 2:    Asian chi_race_eth8       73701 73701 0.22911494 0.0015480599 0.226094981
## 3:    Black chi_race_eth8       73701 73701 0.09036512 0.0010560883 0.088316537
## 4: Hispanic chi_race_eth8       73701 73701 0.13007965 0.0012391123 0.127670314
## 5: Multiple chi_race_eth8       73701 73701 0.04203471 0.0007391714 0.040609678
## 6:     NHPI chi_race_eth8       73701 73701 0.01629557 0.0004663730 0.015406391
## 7:  Oth/unk chi_race_eth8       73701 73701 0.01867003 0.0004985932 0.017717604
## 8:    White chi_race_eth8       73701 73701 0.46813476 0.0018380296 0.464534068
##     mean_upper numerator       rse
##          &lt;num&gt;     &lt;int&gt;     &lt;num&gt;
## 1: 0.005856077       391 5.0438189
## 2: 0.232163131     16886 0.6756696
## 3: 0.092456411      6660 1.1686901
## 4: 0.132527538      9587 0.9525797
## 5: 0.043507475      3098 1.7584788
## 6: 0.017235175      1201 2.8619613
## 7: 0.019672633      1376 2.6705534
## 8: 0.471738775     34502 0.3926283
</code></pre>
<p><strong>2017-2019 rate per 100k of births among each race/eth group</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;chi_race_eth8&quot;), 
     chi_year %in% 2017:2019,
     metrics = c(&quot;obs&quot;, &quot;numerator&quot;, &quot;denominator&quot;, &quot;rate&quot;), 
     per = 100000)[]
</code></pre>
<pre><code>##       level      variable denominator   obs numerator      rate   rate_se
##      &lt;char&gt;        &lt;char&gt;       &lt;int&gt; &lt;int&gt;     &lt;int&gt;     &lt;num&gt;     &lt;num&gt;
## 1:     AIAN chi_race_eth8       73701 73701       391   530.522  26.75857
## 2:    Asian chi_race_eth8       73701 73701     16886 22911.494 154.80599
## 3:    Black chi_race_eth8       73701 73701      6660  9036.512 105.60883
## 4: Hispanic chi_race_eth8       73701 73701      9587 13007.965 123.91123
## 5: Multiple chi_race_eth8       73701 73701      3098  4203.471  73.91714
## 6:     NHPI chi_race_eth8       73701 73701      1201  1629.557  46.63730
## 7:  Oth/unk chi_race_eth8       73701 73701      1376  1867.003  49.85932
## 8:    White chi_race_eth8       73701 73701     34502 46813.476 183.80296
##    rate_lower rate_upper rate_per
##         &lt;num&gt;      &lt;num&gt;    &lt;num&gt;
## 1:   480.5929   585.6077    1e+05
## 2: 22609.4981 23216.3131    1e+05
## 3:  8831.6537  9245.6411    1e+05
## 4: 12767.0314 13252.7538    1e+05
## 5:  4060.9678  4350.7475    1e+05
## 6:  1540.6391  1723.5175    1e+05
## 7:  1771.7604  1967.2633    1e+05
## 8: 46453.4068 47173.8775    1e+05
</code></pre>
<p><strong>Number and proportion of missing gender by year</strong></p>
<pre><code class="language-r">calc(ph.data = birth, 
     what = c(&quot;chi_sex&quot;), 
     chi_year %in% 2017:2019,
     metrics = c(&quot;obs&quot;, &quot;missing&quot;, &quot;missing.prop&quot;), 
     by = &quot;chi_year&quot;)[]
</code></pre>
<pre><code>##    chi_year variable   obs missing missing.prop  level
##       &lt;int&gt;   &lt;char&gt; &lt;int&gt;   &lt;int&gt;        &lt;num&gt; &lt;fctr&gt;
## 1:     2017  chi_sex 25274       0   0.0000e+00   Male
## 2:     2017  chi_sex 25274       0   0.0000e+00 Female
## 3:     2018  chi_sex 24337       0   0.0000e+00 Female
## 4:     2018  chi_sex 24337       0   0.0000e+00   Male
## 5:     2019  chi_sex 24090       2   8.3022e-05   Male
## 6:     2019  chi_sex 24090       2   8.3022e-05 Female
## 7:     2019  chi_sex 24090       2   8.3022e-05   &lt;NA&gt;
</code></pre>
<hr />
<h2 id="example-survey-analyses">Example survey analyses</h2>
<p>Before using <code>calc()</code> with survey data, the user must survey set the data while properly specifying the survey design. Here is an example of how to set <a href="https://github.com/PHSKC-APDE/svy_acs">ACS PUMS</a> person level data:</p>
<pre><code class="language-r">library(survey)
library(data.table)

load(&quot;//dphcifs/APDE-CDIP/ACS/PUMS_data/2021_1_year/prepped_R_files/2021_1_year_data.RData&quot;)

  pums &lt;-     
    survey::svrepdesign(
      weight = ~pwgtp ,
      combined.weights = TRUE ,
      repweights = 'pwgtp[0-9]+' ,
      scale = 4 / 80 ,
      rscales = rep( 1 , 80 ) ,
      mse = TRUE ,
      type = &quot;JK1&quot; ,
      data = person.wa
    )
  
  # New for version 1.0.0
  # This allows for the use of data.table syntax for data cleaning
  # users who prefer dplyr syntax should review the srvyr package
  pums = dtsurvey::dtrepsurvey(pums)
</code></pre>
<p>Once the data has been set as a survey, we can use the <code>calc()</code> function the same way that we used it for vital statistics (birth) data.</p>
<p><strong>Let’s get on the same page re: the meaning of the columns from <code>calc()</code></strong></p>
<p>First, create a simple tabulation of the population of Seattle after sub-setting PUMS to King County.</p>
<pre><code class="language-r">test1 &lt;- calc(ph.data = pums, 
             what = &quot;chi_geo_seattle&quot;, 
             metrics = c('mean', 'numerator', 'denominator', 'obs', 'total'), 
             where = chi_geo_kc == 1)
print(test1)
</code></pre>
<pre><code>##           variable      mean  total numerator denominator   obs  level
##             &lt;char&gt;     &lt;num&gt;  &lt;num&gt;     &lt;num&gt;       &lt;int&gt; &lt;int&gt; &lt;lgcl&gt;
## 1: chi_geo_seattle 0.3257413 733714      6544       21506 21506     NA
##         mean_se mean_lower mean_upper total_se total_lower total_upper
##           &lt;num&gt;      &lt;num&gt;      &lt;num&gt;    &lt;num&gt;       &lt;num&gt;       &lt;num&gt;
## 1: 0.0002685174  0.3252068  0.3262758 783.3842    732154.7    735273.3
</code></pre>
<ul>
<li><code>mean</code>: The proportion of the total population (i.e., King County) that lives in Seattle</li>
<li><code>total</code>: The survey weighted population of King County</li>
<li><code>numerator</code>: The number of rows with people living in Seattle, compare to <code>nrow(pums[chi_geo_seattle == 1])</code></li>
<li><code>denominator</code>: The number of rows in the the dataset where the ‘what’ variable can be assessed because it is not missing, compare to <code>nrow(pums[!is.na(chi_geo_seattle)])</code></li>
<li><code>obs</code>: The number of rows in the dataset after filtering by the ‘where’ argument.</li>
</ul>
<p>To highlight the difference between <code>denominator</code> and <code>obs</code>, in this next example we introduce 100 missing values to our ‘what’ variable (chi_geo_seattle), thereby lowering the denominator by 100 but leaving the obs the same as above.</p>
<pre><code class="language-r">pums2 &lt;- copy(pums)
pums2 &lt;- pums2[chi_geo_seattle == 1, chi_geo_seattle := ifelse(rowid(chi_geo_seattle) &lt;= 100, NA, chi_geo_seattle)]
test2 &lt;- calc(ph.data = pums2, 
             what = &quot;chi_geo_seattle&quot;, 
             metrics = c('mean', 'numerator', 'denominator', 'obs', 'total'), 
             where = chi_geo_kc == 1)
print(test2)
</code></pre>
<pre><code>##           variable      mean  total numerator denominator   obs  level
##             &lt;char&gt;     &lt;num&gt;  &lt;num&gt;     &lt;num&gt;       &lt;int&gt; &lt;int&gt; &lt;lgcl&gt;
## 1: chi_geo_seattle 0.3245334 729686      6444       21406 21506     NA
##         mean_se mean_lower mean_upper total_se total_lower total_upper
##           &lt;num&gt;      &lt;num&gt;      &lt;num&gt;    &lt;num&gt;       &lt;num&gt;       &lt;num&gt;
## 1: 0.0002911538  0.3239538  0.3251129 876.1572    727942.1    731429.9
</code></pre>
<p>You can use this <code>total</code> value to perform sanity checks to make sure that your survey weighted population is more or less what you would expect.</p>
<p>We know that the approximate 2021 populations of WA State, King County, and Seattle were ~7.7 million, ~2.3 million, and 750,000, respectively. How do the following 2021 ACS estimates (i.e., <code>total</code> values) compare?</p>
<pre><code class="language-r"># WA State
calc(ph.data = pums, 
     what = c('chi_geo_wastate'), 
     metrics = c(&quot;numerator&quot;, &quot;total&quot;), 
     proportion = F)[]
</code></pre>
<pre><code>##           variable   total numerator  level total_se total_lower total_upper
##             &lt;char&gt;   &lt;num&gt;     &lt;num&gt; &lt;lgcl&gt;    &lt;num&gt;       &lt;num&gt;       &lt;num&gt;
## 1: chi_geo_wastate 7738692     78528     NA        0     7738692     7738692
</code></pre>
<pre><code class="language-r"># King County
calc(ph.data = pums, 
     what = c(&quot;chi_geo_kc&quot;), 
     metrics = c(&quot;numerator&quot;, &quot;total&quot;), 
     proportion = F)[]
</code></pre>
<pre><code>##      variable   total numerator  level total_se total_lower total_upper
##        &lt;char&gt;   &lt;num&gt;     &lt;num&gt; &lt;lgcl&gt;    &lt;num&gt;       &lt;num&gt;       &lt;num&gt;
## 1: chi_geo_kc 2252444     21506     NA 806.0868     2250840     2254048
</code></pre>
<pre><code class="language-r"># Seattle
calc(ph.data = pums, 
     what = c(&quot;chi_geo_seattle&quot;), 
     metrics = c(&quot;numerator&quot;, &quot;total&quot;), 
     proportion = F)[]
</code></pre>
<pre><code>##           variable  total numerator  level total_se total_lower total_upper
##             &lt;char&gt;  &lt;num&gt;     &lt;num&gt; &lt;lgcl&gt;    &lt;num&gt;       &lt;num&gt;       &lt;num&gt;
## 1: chi_geo_seattle 733714      6544     NA 783.3842    732154.7    735273.3
</code></pre>
<p>Now that we’ve established that our survey data is reasonable, we can continue with our analyses.</p>
<p><strong>Mean (proportion) of those near poverty or disabled, by King County (vs. remainder of WA)</strong></p>
<pre><code class="language-r">calc(ph.data = pums, 
     what = c(&quot;disability&quot;, &quot;GEpov200&quot;), 
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;obs&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     proportion = T, 
     by = &quot;chi_geo_kc&quot;)[]
</code></pre>
<pre><code>##    chi_geo_kc                level   variable denominator   obs       mean
##         &lt;num&gt;               &lt;char&gt;     &lt;char&gt;       &lt;int&gt; &lt;int&gt;      &lt;num&gt;
## 1:          0    With a disability disability       57022 57022 0.14747784
## 2:          0 Without a disability disability       57022 57022 0.85252216
## 3:          1    With a disability disability       21506 21506 0.09669408
## 4:          1 Without a disability disability       21506 21506 0.90330592
## 5:          0                 &lt;NA&gt;   GEpov200       55189 57022 0.75367067
## 6:          1                 &lt;NA&gt;   GEpov200       20903 21506 0.81720067
##        mean_se mean_lower mean_upper numerator       rse
##          &lt;num&gt;      &lt;num&gt;      &lt;num&gt;     &lt;num&gt;     &lt;num&gt;
## 1: 0.001891511 0.14375249  0.1512827      9374 1.2825730
## 2: 0.001891511 0.84871732  0.8562475     47648 0.2218723
## 3: 0.002422061 0.09197924  0.1016236      2404 2.5048703
## 4: 0.002422061 0.89837645  0.9080208     19102 0.2681330
## 5: 0.003509537 0.74661863  0.7605894     42256 0.4656592
## 6: 0.005045638 0.80694268  0.8270304     17450 0.6174295
</code></pre>
<p><strong>Proportion in each CHNA age group, by disability status</strong></p>
<pre><code class="language-r">calc(ph.data = pums, 
     what = c(&quot;age6&quot;), 
     metrics = c(&quot;mean&quot;, &quot;rse&quot;, &quot;obs&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     proportion = F, 
     by = &quot;disability&quot;)[]
</code></pre>
<pre><code>##               disability  level variable denominator   obs       mean
##                   &lt;fctr&gt; &lt;char&gt;   &lt;char&gt;       &lt;int&gt; &lt;int&gt;      &lt;num&gt;
##  1: Without a disability  18-24     age6       66750 66750 0.09003360
##  2: Without a disability  25-44     age6       66750 66750 0.30849010
##  3: Without a disability  45-64     age6       66750 66750 0.23985748
##  4: Without a disability  65-74     age6       66750 66750 0.08861491
##  5: Without a disability    75+     age6       66750 66750 0.03488903
##  6: Without a disability    &lt;18     age6       66750 66750 0.23811488
##  7:    With a disability  18-24     age6       11778 11778 0.06026304
##  8:    With a disability  25-44     age6       11778 11778 0.18713056
##  9:    With a disability  45-64     age6       11778 11778 0.26687071
## 10:    With a disability  65-74     age6       11778 11778 0.18508946
## 11:    With a disability    75+     age6       11778 11778 0.22731664
## 12:    With a disability    &lt;18     age6       11778 11778 0.07332958
##          mean_se mean_lower mean_upper numerator       rse
##            &lt;num&gt;      &lt;num&gt;      &lt;num&gt;     &lt;int&gt;     &lt;num&gt;
##  1: 0.0006471355 0.08874551 0.09132169      5545 0.7187710
##  2: 0.0011385162 0.30622394 0.31075626     18734 0.3690608
##  3: 0.0009444442 0.23797761 0.24173735     16968 0.3937522
##  4: 0.0006455150 0.08733004 0.08989977      7519 0.7284496
##  5: 0.0005355253 0.03382310 0.03595497      3197 1.5349388
##  6: 0.0006944167 0.23673267 0.23949708     14787 0.2916310
##  7: 0.0025721168 0.05514337 0.06538271       610 4.2681494
##  8: 0.0056229482 0.17593836 0.19832276      1760 3.0048262
##  9: 0.0053801195 0.25616185 0.27757957      2959 2.0160022
## 10: 0.0040474656 0.17703318 0.19314574      2390 2.1867618
## 11: 0.0033096096 0.22072902 0.23390425      3342 1.4559469
## 12: 0.0037292750 0.06590664 0.08075252       717 5.0856353
</code></pre>
<p><strong>Mean &amp; median age in King County, by disability status</strong></p>
<pre><code class="language-r">calc(ph.data = pums, 
     what = c(&quot;agep&quot;),
     chi_geo_kc == 1,
     metrics = c(&quot;mean&quot;, &quot;median&quot;, &quot;rse&quot;, &quot;obs&quot;, &quot;numerator&quot;, &quot;denominator&quot;), 
     by = &quot;disability&quot;)[]
</code></pre>
<pre><code>##              disability variable     mean median numerator denominator   obs
##                  &lt;fctr&gt;   &lt;char&gt;    &lt;num&gt;  &lt;num&gt;     &lt;int&gt;       &lt;int&gt; &lt;int&gt;
## 1:    With a disability     agep 56.32190     64    142658        2404  2404
## 2: Without a disability     agep 36.57783     38    727379       19102 19102
##     level    mean_se mean_lower mean_upper       rse
##    &lt;lgcl&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;     &lt;num&gt;
## 1:     NA 0.66249953   55.00323   57.64057 1.1762734
## 2:     NA 0.06941677   36.43966   36.71600 0.1897783
</code></pre>
<hr />
<h2 id="example-analyses-with-non-standard-data">Example analyses with non-standard data</h2>
<p>In the examples above we used standard public health data (birth vital statistics and the Census Bureau’s ACS survey). However, since <code>calc()</code> is a generalized function, you can use it with nearly any dataset, as long as it is a data.frame, a data.table, or a survey object. To demonstrate this, we will use <code>calc()</code> with synthetic data that we will generate below.</p>
<p><strong>Create the dataset</strong></p>
<pre><code class="language-r">library(data.table)
set.seed(98121) 

mydt &lt;- data.table(
  school = as.factor(sample(c(&quot;Alpha&quot;, &quot;Beta&quot;, &quot;Gamma&quot;, &quot;Delta&quot;), 2000, replace = T)),
  grades = as.factor(sample(c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;), 2000, replace = T)), 
  year = sample(2016:2021, 2000, replace = T))

mydt[]
</code></pre>
<pre><code>##       school grades  year
##       &lt;fctr&gt; &lt;fctr&gt; &lt;int&gt;
##    1:  Alpha      A  2017
##    2:  Delta      B  2019
##    3:  Gamma      C  2017
##    4:   Beta      A  2016
##    5:  Delta      C  2018
##   ---                    
## 1996:  Alpha      C  2018
## 1997:   Beta      B  2021
## 1998:  Delta      C  2020
## 1999:  Delta      D  2019
## 2000:  Delta      D  2018
</code></pre>
<p>We see that we created a dataset of 2000 rows with grades in four schools between with 2016 and 2021.</p>
<p><strong>Calculate the proportion of A’s and B’s in the Alpha and Beta schools</strong></p>
<pre><code class="language-r">grades.distribution &lt;- calc(
  ph.data = mydt, 
  school %in% c(&quot;Alpha&quot;, &quot;Beta&quot;), 
  what = &quot;grades&quot;, 
  by = &quot;school&quot;, 
  time_var = &quot;year&quot;, 
  metrics = c(&quot;numerator&quot;, &quot;denominator&quot;, &quot;mean&quot;), proportion = F)

grades.distribution[level %in% c(&quot;A&quot;, &quot;B&quot;)]
</code></pre>
<pre><code>##    school  level      year variable denominator      mean    mean_se mean_lower
##    &lt;fctr&gt; &lt;char&gt;    &lt;char&gt;   &lt;char&gt;       &lt;int&gt;     &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
## 1:  Alpha      A 2016-2021   grades         497 0.2857143 0.02028435  0.2477598
## 2:  Alpha      B 2016-2021   grades         497 0.2555332 0.01958418  0.2191639
## 3:   Beta      A 2016-2021   grades         491 0.2484725 0.01952152  0.2123012
## 4:   Beta      B 2016-2021   grades         491 0.2566191 0.01973114  0.2199795
##    mean_upper numerator
##         &lt;num&gt;     &lt;int&gt;
## 1:  0.3269560       142
## 2:  0.2956526       127
## 3:  0.2885490       122
## 4:  0.2970375       126
</code></pre>
<p>These results show that the Alpha School has a higher proportion of A’s (0.286 vs 0.248) and a similar proportion of B’s (0.256 vs 0.257).</p>
<p><strong>Wait! We forgot the survey weights!</strong></p>
<p>A colleague just reminded you that you forgot to add the survey weights. Let’s add weights and survey set the data.</p>
<pre><code class="language-r"># create weights
set.seed(98121)
mydt[, mywghts := sample(50:1300, 2000, replace = T)]

# survey set the data
# This uses the dtsurvey package
# similar logic applies for survey and srvyr package
mydt[, `_id` := NULL] # remove id to make things play nice
mysvy &lt;-dtsurvey::dtsurvey(data.table(mydt), weight = 'mywghts')
</code></pre>
<p><strong>Using the survey information, again calculate the proportion of A’s and B’s in the Alpha and Beta schools</strong></p>
<pre><code class="language-r">grades.distribution2 &lt;- calc(
  ph.data = mysvy, 
  school %in% c(&quot;Alpha&quot;, &quot;Beta&quot;), 
  what = &quot;grades&quot;, 
  by = &quot;school&quot;, 
  time_var = &quot;year&quot;, 
  metrics = c(&quot;numerator&quot;, &quot;denominator&quot;, &quot;mean&quot;), proportion = FALSE)

grades.distribution2[level %in% c(&quot;A&quot;, &quot;B&quot;)]
</code></pre>
<pre><code>##    school  level      year variable denominator      mean    mean_se mean_lower
##    &lt;fctr&gt; &lt;char&gt;    &lt;char&gt;   &lt;char&gt;       &lt;int&gt;     &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
## 1:  Alpha      A 2016-2021   grades         497 0.2819952 0.02280603  0.2371869
## 2:  Alpha      B 2016-2021   grades         497 0.2460211 0.02157805  0.2036254
## 3:   Beta      A 2016-2021   grades         491 0.2361366 0.02142621  0.1940380
## 4:   Beta      B 2016-2021   grades         491 0.2685865 0.02295556  0.2234831
##    mean_upper numerator
##         &lt;num&gt;     &lt;int&gt;
## 1:  0.3268036       142
## 2:  0.2884167       127
## 3:  0.2782351       122
## 4:  0.3136900       126
</code></pre>
<p>You’ll note that using the survey design caused small changes in the results. For examples, the proportion of A’s in the Alpha school changed from 0.286 to 0.282.</p>
<hr />
<h2 id="knowing-is-half-the-battle-but-only-half">Knowing is half the battle … but only half</h2>
<p>You’ve been introduced to <code>calc()</code>, but you’ll only become competent at using it by using it. Try it out with your favorite dataset. Use it to answer data requests. Play with it. Try to break it and, if you’re successful, submit a <a href="https://github.com/PHSKC-APDE/rads/issues/new">GitHub issue</a>. Enjoy!</p>
</div>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>
</body>
</html>
